{% extends "lessons/base.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <h2>Record Student Payments</h2>

    <!-- Class selection filter -->
    <form method="get" class="mb-3">
        <label for="class_group">Select Class:</label>
        <select name="class_group" id="class_group" onchange="this.form.submit()">
            <option value="">--Choose--</option>
            {% for cls in class_groups %}
                <option value="{{ cls.id }}" {% if selected_class_id == cls.id|stringformat:"s" %}selected{% endif %}>{{ cls.name }}</option>
            {% endfor %}
        </select>
    </form>

    {% if selected_class_id %}
        <button id="addStudentBtn" style="margin-bottom: 10px;">Add Student</button>
        <input type="text" id="searchInput" class="search-box" placeholder="Search students...">

        <table id="studentTable" class="table table-bordered">
            <thead>
                <tr>
                    <th onclick="sortTable(0)">First Name ▲▼</th>
                    <th onclick="sortTable(1)">Last Name</th>
                    <th onclick="sortTable(2)">Admission No.</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for student in students %}
                <tr data-id="{{ student.id }}">
                    <td>{{ student.first_name }}</td>
                    <td>{{ student.last_name }}</td>
                    <td>{{ student.admission_number }}</td>
                    <td>
                        <button class="action-btn" onclick="editStudent({{ student.id }})">Edit</button>
                        <button class="delete-btn" onclick="deleteStudent({{ student.id }})">Delete</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p>Please select a class to see students.</p>
    {% endif %}
</div>

<!-- Modal for Add/Edit -->
<div id="studentModal" class="modal">
    <div class="modal-content">
        <h3 id="modalTitle">Add Student</h3>
        <input type="text" id="firstName" placeholder="First Name">
        <input type="text" id="lastName" placeholder="Last Name">
        <input type="text" id="admissionNo" placeholder="Admission Number">
        <div style="margin-top: 10px;">
            <button id="saveBtn" style="background:#28a745; color:#fff;">Save</button>
            <button id="cancelBtn" style="background:#6c757d; color:#fff;">Cancel</button>
        </div>
    </div>
</div>

<script>
const modal = document.getElementById('studentModal');
const addBtn = document.getElementById('addStudentBtn');
const saveBtn = document.getElementById('saveBtn');
const cancelBtn = document.getElementById('cancelBtn');
const modalTitle = document.getElementById('modalTitle');
const firstNameInput = document.getElementById('firstName');
const lastNameInput = document.getElementById('lastName');
const admissionNoInput = document.getElementById('admissionNo');
const searchInput = document.getElementById('searchInput');
const studentTableBody = document.querySelector('#studentTable tbody');

let currentStudentId = null;

// Open modal
function openModal(edit = false, studentId = null) {
    modal.style.display = 'flex';
    currentStudentId = studentId;

    if(edit && studentId) {
        modalTitle.textContent = 'Edit Student';
        const row = document.querySelector(`tr[data-id='${studentId}']`);
        firstNameInput.value = row.children[0].textContent;
        lastNameInput.value = row.children[1].textContent;
        admissionNoInput.value = row.children[2].textContent;
    } else {
        modalTitle.textContent = 'Add Student';
        firstNameInput.value = '';
        lastNameInput.value = '';
        admissionNoInput.value = '';
    }
}

function closeModal() { modal.style.display = 'none'; }

// AJAX Save
if(saveBtn) saveBtn.addEventListener('click', () => {
    const firstName = firstNameInput.value.trim();
    const lastName = lastNameInput.value.trim();
    const admissionNo = admissionNoInput.value.trim();
    const classGroup = document.getElementById('class_group').value;

    if(!firstName || !lastName || !admissionNo) {
        alert('Please fill all fields.');
        return;
    }

    const url = currentStudentId
        ? `/edit-student/${currentStudentId}/`   // edit endpoint
        : `/add-student/`;                      // add endpoint

    fetch(url, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: `first_name=${firstName}&last_name=${lastName}&admission_number=${admissionNo}&class_group=${classGroup}`
    })
    .then(res => res.json())
    .then(data => {
        if(currentStudentId) {
            const row = document.querySelector(`tr[data-id='${currentStudentId}']`);
            row.children[0].textContent = firstName;
            row.children[1].textContent = lastName;
            row.children[2].textContent = admissionNo;
        } else {
            const newRow = document.createElement('tr');
            newRow.setAttribute('data-id', data.id);
            newRow.innerHTML = `
                <td>${firstName}</td>
                <td>${lastName}</td>
                <td>${admissionNo}</td>
                <td>
                    <button class="action-btn" onclick="editStudent(${data.id})">Edit</button>
                    <button class="delete-btn" onclick="deleteStudent(${data.id})">Delete</button>
                </td>
            `;
            studentTableBody.appendChild(newRow);
        }
        closeModal();
    });
});

// Delete
function deleteStudent(studentId) {
    if(!confirm('Are you sure you want to delete this student?')) return;

    fetch(`/delete-student/${studentId}/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': '{{ csrf_token }}' }
    })
    .then(res => res.json())
    .then(data => {
        if(data.success) {
            const row = document.querySelector(`tr[data-id='${studentId}']`);
            row.remove();
        }
    });
}

// Edit button
function editStudent(studentId) { openModal(true, studentId); }

// Search filter
if(searchInput) searchInput.addEventListener('input', () => {
    const filter = searchInput.value.toLowerCase();
    Array.from(studentTableBody.children).forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(filter) ? '' : 'none';
    });
});

if(addBtn) addBtn.addEventListener('click', () => openModal());
if(cancelBtn) cancelBtn.addEventListener('click', closeModal);
</script>
{% endblock %}
