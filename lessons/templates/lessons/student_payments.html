{% extends "lessons/base.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <h2>Record Student Payments</h2>

    <!-- Class selection filter -->
    <form method="get" class="mb-3">
        <label for="class_group">Select Class:</label>
        <select name="class_group" id="class_group" onchange="this.form.submit()">
            <option value="">--Choose--</option>
            {% for cls in class_groups %}
                <option value="{{ cls.id }}" {% if selected_class_id == cls.id|stringformat:"s" %}selected{% endif %}>{{ cls.name }}</option>
            {% endfor %}
        </select>
    </form>

    {% if selected_class_id %}
        <button id="addStudentBtn" style="margin-bottom: 10px;">Add Student</button>
        <input type="text" id="searchInput" class="search-box" placeholder="Search students...">

        <table id="studentTable" class="table table-bordered">
            <thead>
                <tr>
                    <th onclick="sortTable(0)">First Name ▲▼</th>
                    <th onclick="sortTable(1)">Last Name</th>
                    <th onclick="sortTable(2)">Admission No.</th>
                    <th>Amount Paid</th>
                    <th>Balance</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for student in students %}
                <tr data-id="{{ student.id }}">
                    <td class="first-name">{{ student.first_name }}</td>
                    <td class="last-name">{{ student.last_name }}</td>
                    <td class="admission-no">{{ student.admission_number }}</td>
                    <td>
                        <input type="number" step="0.01" name="amount_{{ student.id }}" placeholder="Enter amount" 
                               value="{{ student.amount_paid }}" onchange="updatePayment({{ student.id }}, this.value)">
                    </td>
                    <td class="balance">{{ student.balance }}</td>
                    <td>
                        <button type="button" class="action-btn" onclick="editStudent({{ student.id }})">Edit</button>
                        <button type="button" class="delete-btn" onclick="deleteStudent({{ student.id }})">Delete</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- Statistics panel -->
        <div id="statistics" style="margin-top:20px; background:#f4f4f4; padding:10px; border-radius:6px;">
            <strong>Statistics:</strong>
            <span>Total Students: <span id="statTotal">{{ total_students }}</span></span> |
            <span>Total Paid: <span id="statPaid">{{ total_paid }}</span></span> |
            <span>Total Unpaid: <span id="statUnpaid">{{ total_unpaid }}</span></span> |
            <span>Fully Paid: <span id="statFullyPaid">{{ fully_paid }}</span></span> |
            <span>Partial: <span id="statPartial">{{ partial_paid }}</span></span>
        </div>

    {% else %}
        <p>Please select a class to see students.</p>
    {% endif %}
</div>

<!-- Modal for Add/Edit -->
<div id="studentModal" class="modal">
    <div class="modal-content">
        <h3 id="modalTitle">Add Student</h3>
        <input type="text" id="firstName" placeholder="First Name">
        <input type="text" id="lastName" placeholder="Last Name">
        <input type="text" id="admissionNo" placeholder="Admission Number">
        <div style="margin-top: 10px;">
            <button id="saveBtn" style="background:#28a745; color:#fff;">Save</button>
            <button id="cancelBtn" style="background:#6c757d; color:#fff;">Cancel</button>
        </div>
    </div>
</div>

<style>
body { font-family: Arial, sans-serif; padding: 20px; background: #f9f9f9; }
h1, h2 { color: #333; }
button { padding: 8px 12px; margin-right: 5px; border: none; border-radius: 4px; cursor: pointer; }
.action-btn { background: #007bff; color: #fff; }
.action-btn:hover { background: #0056b3; }
.delete-btn { background: #dc3545; color: #fff; }
.delete-btn:hover { background: #b02a37; }
input.search-box { padding: 8px; width: 300px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #ccc; }
table { width: 100%; border-collapse: collapse; margin-top: 10px; background: #fff; }
th, td { border: 1px solid #ccc; padding: 10px; text-align: left; }
th { background-color: #f4f4f4; cursor: pointer; }
tbody tr:hover { background-color: #f1f1f1; }
.modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
.modal-content { background-color: #fff; padding: 20px; border-radius: 8px; width: 320px; }
.modal input { width: 100%; padding: 8px; margin: 5px 0; border-radius: 4px; border: 1px solid #ccc; }
</style>

<script>
const modal = document.getElementById('studentModal');
const addBtn = document.getElementById('addStudentBtn');
const saveBtn = document.getElementById('saveBtn');
const cancelBtn = document.getElementById('cancelBtn');
const modalTitle = document.getElementById('modalTitle');
const firstNameInput = document.getElementById('firstName');
const lastNameInput = document.getElementById('lastName');
const admissionNoInput = document.getElementById('admissionNo');
const searchInput = document.getElementById('searchInput');
const studentTableBody = document.querySelector('#studentTable tbody');

let editStudentId = null;

function openModal(edit=false, studentId=null) {
    modal.style.display = 'flex';
    if(edit) {
        modalTitle.textContent = 'Edit Student';
        const row = document.querySelector(`tr[data-id="${studentId}"]`);
        firstNameInput.value = row.querySelector('.first-name').textContent;
        lastNameInput.value = row.querySelector('.last-name').textContent;
        admissionNoInput.value = row.querySelector('.admission-no').textContent;
        editStudentId = studentId;
    } else {
        modalTitle.textContent = 'Add Student';
        firstNameInput.value = '';
        lastNameInput.value = '';
        admissionNoInput.value = '';
        editStudentId = null;
    }
}

function closeModal() { modal.style.display = 'none'; }

function refreshRow(student) {
    const existingRow = document.querySelector(`tr[data-id="${student.id}"]`);
    if(existingRow) {
        existingRow.querySelector('.first-name').textContent = student.first_name;
        existingRow.querySelector('.last-name').textContent = student.last_name;
        existingRow.querySelector('.admission-no').textContent = student.admission_number;
    } else {
        const row = document.createElement('tr');
        row.dataset.id = student.id;
        row.innerHTML = `
            <td class="first-name">${student.first_name}</td>
            <td class="last-name">${student.last_name}</td>
            <td class="admission-no">${student.admission_number}</td>
            <td><input type="number" step="0.01" name="amount_${student.id}" placeholder="Enter amount" onchange="updatePayment(${student.id}, this.value)"></td>
            <td class="balance">1500</td>
            <td>
                <button type="button" class="action-btn" onclick="editStudent(${student.id})">Edit</button>
                <button type="button" class="delete-btn" onclick="deleteStudent(${student.id})">Delete</button>
            </td>
        `;
        studentTableBody.appendChild(row);
    }
}

// Add / Edit student via AJAX
saveBtn.addEventListener('click', () => {
    const firstName = firstNameInput.value.trim();
    const lastName = lastNameInput.value.trim();
    const admissionNo = admissionNoInput.value.trim();
    if(!firstName || !lastName || !admissionNo) { alert('Please fill all fields'); return; }

    let url = '';
    let method = 'POST';
    let formData = new FormData();
    formData.append('first_name', firstName);
    formData.append('last_name', lastName);
    formData.append('admission_number', admissionNo);
    formData.append('class_group', document.getElementById('class_group').
