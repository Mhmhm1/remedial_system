{% extends "lessons/base.html" %}
{% load static %}

{% block content %}

<div class="container mt-4">  
    <h2>Record Student Payments</h2>  
    <!-- Class selection filter -->  
    <form method="get" class="mb-3">  
        <label for="class_group">Select Class:</label>  
        <select name="class_group" id="class_group" onchange="this.form.submit()">  
            <option value="">--Choose--</option>  
            {% for cls in class_groups %}  
                <option value="{{ cls.id }}" {% if selected_class_id == cls.id|stringformat:"s" %}selected{% endif %}>{{ cls.name }}</option>  
            {% endfor %}  
        </select>  
    </form>  

    {% if selected_class_id %}  
        <button id="addStudentBtn" style="margin-bottom: 10px;">Add Student</button>  
        <input type="text" id="searchInput" class="search-box" placeholder="Search students...">  

        <table id="studentTable" class="table table-bordered">  
            <thead>  
                <tr>  
                    <th onclick="sortTable(0)">First Name ▲▼</th>  
                    <th onclick="sortTable(1)">Last Name</th>  
                    <th onclick="sortTable(2)">Admission No.</th>  
                    <th>Action</th>  
                </tr>  
            </thead>  
            <tbody>  
                {% for student in students %}  
                <tr data-id="{{ student.id }}">  
                    <td>{{ student.first_name }}</td>  
                    <td>{{ student.last_name }}</td>  
                    <td>{{ student.admission_number }}</td>  
                    <td>  
                        <button class="action-btn" onclick="editStudent({{ forloop.counter0 }})">Edit</button>  
                        <button class="delete-btn" onclick="deleteStudent({{ forloop.counter0 }})">Delete</button>  
                    </td>  
                </tr>  
                {% endfor %}  
            </tbody>  
        </table>  
    {% else %}  
        <p>Please select a class to see students.</p>  
    {% endif %}

</div>  

<!-- Modal for Add/Edit -->  
<div id="studentModal" class="modal">  
    <div class="modal-content">  
        <h3 id="modalTitle">Add Student</h3>  
        <input type="text" id="firstName" placeholder="First Name">  
        <input type="text" id="lastName" placeholder="Last Name">  
        <input type="text" id="admissionNo" placeholder="Admission Number">  
        <div style="margin-top: 10px;">  
            <button id="saveBtn" style="background:#28a745; color:#fff;">Save</button>  
            <button id="cancelBtn" style="background:#6c757d; color:#fff;">Cancel</button>  
        </div>  
    </div>  
</div>  

<style>
  /* Modal and table styling */
  body { font-family: Arial, sans-serif; padding: 20px; background: #f9f9f9; }
  h1, h2 { color: #333; }
  button { padding: 8px 12px; margin-right: 5px; border: none; border-radius: 4px; cursor: pointer; }
  .action-btn { background: #007bff; color: #fff; }
  .action-btn:hover { background: #0056b3; }
  .delete-btn { background: #dc3545; color: #fff; }
  .delete-btn:hover { background: #b02a37; }
  input.search-box { padding: 8px; width: 300px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #ccc; }
  table { width: 100%; border-collapse: collapse; margin-top: 10px; background: #fff; }
  th, td { border: 1px solid #ccc; padding: 10px; text-align: left; }
  th { background-color: #f4f4f4; cursor: pointer; }
  tbody tr:hover { background-color: #f1f1f1; }
  .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
  .modal-content { background-color: #fff; padding: 20px; border-radius: 8px; width: 320px; }
  .modal input { width: 100%; padding: 8px; margin: 5px 0; border-radius: 4px; border: 1px solid #ccc; }
</style>

<script>
let students = [];
let studentIds = [];

{% if selected_class_id and students %}
students = [
  {% for student in students %}
    {firstName: "{{ student.first_name }}", lastName: "{{ student.last_name }}", admissionNo: "{{ student.admission_number }}"},
  {% endfor %}
];
studentIds = [
  {% for student in students %}
    {{ student.id }},
  {% endfor %}
];
{% endif %}

let editIndex = null;
const modal = document.getElementById('studentModal');
const addBtn = document.getElementById('addStudentBtn');
const saveBtn = document.getElementById('saveBtn');
const cancelBtn = document.getElementById('cancelBtn');
const modalTitle = document.getElementById('modalTitle');
const firstNameInput = document.getElementById('firstName');
const lastNameInput = document.getElementById('lastName');
const admissionNoInput = document.getElementById('admissionNo');
const searchInput = document.getElementById('searchInput');
const studentTableBody = document.querySelector('#studentTable tbody');

function openModal(edit = false, index = null) {
  modal.style.display = 'flex';
  if(edit) {
    modalTitle.textContent = 'Edit Student';
    firstNameInput.value = students[index].firstName;
    lastNameInput.value = students[index].lastName;
    admissionNoInput.value = students[index].admissionNo;
    editIndex = index;
  } else {
    modalTitle.textContent = 'Add Student';
    firstNameInput.value = '';
    lastNameInput.value = '';
    admissionNoInput.value = '';
    editIndex = null;
  }
}

function closeModal() { modal.style.display = 'none'; }

function renderTable() {
  const filter = searchInput.value.toLowerCase();
  if(!studentTableBody) return;
  studentTableBody.innerHTML = '';
  students.forEach((s, index) => {
    if (
      s.firstName.toLowerCase().includes(filter) ||
      s.lastName.toLowerCase().includes(filter) ||
      s.admissionNo.toLowerCase().includes(filter)
    ) {
      const row = document.createElement('tr');
      row.setAttribute('data-id', studentIds[index]);
      row.innerHTML = `
        <td>${s.firstName}</td>
        <td>${s.lastName}</td>
        <td>${s.admissionNo}</td>
        <td>
          <button class="action-btn" onclick="editStudent(${index})">Edit</button>
          <button class="delete-btn" onclick="deleteStudent(${index})">Delete</button>
        </td>
      `;
      studentTableBody.appendChild(row);
    }
  });
}

function saveStudentAjax(firstName, lastName, admissionNo, callback) {
  let url = "{% url 'add_student_ajax' %}";
  let data = new FormData();
  data.append('first_name', firstName);
  data.append('last_name', lastName);
  data.append('admission_number', admissionNo);
  data.append('class_group', "{{ selected_class_id }}");
  fetch(url, {
    method: 'POST',
    headers: { 'X-CSRFToken': '{{ csrf_token }}' },
    body: data
  }).then(res => res.json()).then(response => callback(response));
}

function editStudentAjax(studentId, firstName, lastName, admissionNo, callback) {
  let url = `/edit-student-ajax/${studentId}/`;
  let data = new FormData();
  data.append('first_name', firstName);
  data.append('last_name', lastName);
  data.append('admission_number', admissionNo);
  fetch(url, {
    method: 'POST',
    headers: { 'X-CSRFToken': '{{ csrf_token }}' },
    body: data
  }).then(res => res.json()).then(response => callback(response));
}

function deleteStudentAjax(studentId, callback) {
  let url = `/delete-student-ajax/${studentId}/`;
  let data = new FormData();
  fetch(url, {
    method: 'POST',
    headers: { 'X-CSRFToken': '{{ csrf_token }}' },
    body: data
  }).then(res => res.json()).then(response => callback(response));
}

function editStudent(index) { openModal(true, index); }

function deleteStudent(index) {
  if(confirm('Are you sure you want to delete this student?')) {
    const studentId = studentIds[index];
    deleteStudentAjax(studentId, () => {
      students.splice(index, 1);
      studentIds.splice(index, 1);
      renderTable();
    });
  }
}

if(addBtn) addBtn.addEventListener('click', () => openModal());
if(cancelBtn) cancelBtn.addEventListener('click', closeModal);
if(saveBtn) saveBtn.addEventListener('click', () => {
  const firstName = firstNameInput.value.trim();
  const lastName = lastNameInput.value.trim();
  const admissionNo = admissionNoInput.value.trim();
if(!firstName || !lastName || !admissionNo) { alert('Please fill all fields.'); return; }

  if(editIndex !== null) {
    // Edit existing student
    const studentId = studentIds[editIndex];
    editStudentAjax(studentId, firstName, lastName, admissionNo, (response) => {
      students[editIndex] = { firstName, lastName, admissionNo };
      renderTable();
      closeModal();
    });
  } else {
    // Add new student
    saveStudentAjax(firstName, lastName, admissionNo, (response) => {
      students.push({ firstName, lastName, admissionNo });
      studentIds.push(response.id);  // store new student id
      renderTable();
      closeModal();
    });
  }
});

if(searchInput) searchInput.addEventListener('input', renderTable);
</script>

{% endblock %}
