{% extends "lessons/base.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <h1>Student Dashboard</h1>

    <!-- Class selection -->
    <form method="get" class="mb-3">
        <label>Select Class:</label>
        <select name="class_group" onchange="this.form.submit()">
            <option value="">--Choose--</option>
            {% for cls in class_groups %}
                <option value="{{ cls.id }}" {% if selected_class_id == cls.id|stringformat:"s" %}selected{% endif %}>{{ cls.name }}</option>
            {% endfor %}
        </select>
    </form>

    {% if students %}
    <button id="addStudentBtn">Add Student</button>
    <input type="text" id="searchInput" class="search-box" placeholder="Search students...">

    <form method="post">
        {% csrf_token %}
        <table id="studentTable">
            <thead>
                <tr>
                    <th>First Name ▲▼</th>
                    <th>Last Name</th>
                    <th>Admission No.</th>
                    <th>Amount Paid (Ksh)</th>
                    <th>Balance (Ksh)</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for student in students %}
                <tr>
                    <td>{{ student.first_name }}</td>
                    <td>{{ student.last_name }}</td>
                    <td>{{ student.admission_number }}</td>
                    <td>
                        <input type="number" name="amount_{{ student.id }}" min="0" step="0.01" class="form-control">
                    </td>
                    <td>{{ student.balance|floatformat:2 }}</td>
                    <td>
                        <button type="button" class="action-btn edit-btn" data-id="{{ student.id }}" data-first="{{ student.first_name }}" data-last="{{ student.last_name }}" data-adm="{{ student.admission_number }}">Edit</button>
                        <button type="button" class="delete-btn" data-id="{{ student.id }}">Delete</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <button type="submit" class="btn btn-primary mt-3">Save Payments</button>
    </form>
    {% else %}
        <p>Please select a class to see students.</p>
    {% endif %}
</div>

<!-- Modal for Add/Edit -->
<div id="studentModal" class="modal">
  <div class="modal-content">
    <h3 id="modalTitle">Add Student</h3>
    <input type="text" id="firstName" placeholder="First Name">
    <input type="text" id="lastName" placeholder="Last Name">
    <input type="text" id="admissionNo" placeholder="Admission Number">
    <div style="margin-top: 10px;">
      <button id="saveBtn" style="background:#28a745; color:#fff;">Save</button>
      <button id="cancelBtn" style="background:#6c757d; color:#fff;">Cancel</button>
    </div>
  </div>
</div>

<script>
let students = [
  {% for student in students %}
    {firstName: "{{ student.first_name }}", lastName: "{{ student.last_name }}", admissionNo: "{{ student.admission_number }}"},
  {% endfor %}
];

let editIndex = null;

const modal = document.getElementById('studentModal');
const addBtn = document.getElementById('addStudentBtn');
const saveBtn = document.getElementById('saveBtn');
const cancelBtn = document.getElementById('cancelBtn');
const modalTitle = document.getElementById('modalTitle');

const firstNameInput = document.getElementById('firstName');
const lastNameInput = document.getElementById('lastName');
const admissionNoInput = document.getElementById('admissionNo');
const searchInput = document.getElementById('searchInput');

const studentTableBody = document.querySelector('#studentTable tbody');

function openModal(edit = false, index = null) {
  modal.style.display = 'flex';
  if(edit) {
    modalTitle.textContent = 'Edit Student';
    firstNameInput.value = students[index].firstName;
    lastNameInput.value = students[index].lastName;
    admissionNoInput.value = students[index].admissionNo;
    editIndex = index;
  } else {
    modalTitle.textContent = 'Add Student';
    firstNameInput.value = '';
    lastNameInput.value = '';
    admissionNoInput.value = '';
    editIndex = null;
  }
}

function closeModal() { modal.style.display = 'none'; }

function renderTable() {
  const filter = searchInput.value.toLowerCase();
  studentTableBody.innerHTML = '';
  students.forEach((s, index) => {
    if (
      s.firstName.toLowerCase().includes(filter) ||
      s.lastName.toLowerCase().includes(filter) ||
      s.admissionNo.toLowerCase().includes(filter)
    ) {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${s.firstName}</td>
        <td>${s.lastName}</td>
        <td>${s.admissionNo}</td>
        <td><input type="number" name="amount_${index}" min="0" step="0.01" class="form-control"></td>
        <td>0.00</td>
        <td>
          <button type="button" class="action-btn" onclick="editStudent(${index})">Edit</button>
          <button type="button" class="delete-btn" onclick="deleteStudent(${index})">Delete</button>
        </td>
      `;
      studentTableBody.appendChild(row);
    }
  });
}

function editStudent(index) { openModal(true, index); }

function deleteStudent(index) {
  if(confirm('Are you sure you want to delete this student?')) {
    students.splice(index, 1);
    renderTable();
  }
}

addBtn.addEventListener('click', () => openModal());
cancelBtn.addEventListener('click', closeModal);

saveBtn.addEventListener('click', () => {
  const firstName = firstNameInput.value.trim();
  const lastName = lastNameInput.value.trim();
  const admissionNo = admissionNoInput.value.trim();

  if(!firstName || !lastName || !admissionNo) {
    alert('Please fill all fields.');
    return;
  }

  if(editIndex !== null) {
    students[editIndex] = { firstName, lastName, admissionNo };
  } else {
    students.push({ firstName, lastName, admissionNo });
  }

  renderTable();
  closeModal();
});

searchInput.addEventListener('input', renderTable);
renderTable();
</script>
{% endblock %}
