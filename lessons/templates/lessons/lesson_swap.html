{% extends "lessons/base.html" %}
{% load static %}

{% block title %}Teacher Dashboard{% endblock %}

{% block content %}

<div class="profile-container">
    <div>
        <form action="{% url 'update_profile_picture' %}" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <label for="profile_picture" style="cursor:pointer;">
                {% if teacher.profile_picture %}
                    <img src="{{ teacher.profile_picture.url }}" alt="Profile" />
                {% else %}
                    <img src="{% static 'lessons/img/default_profile.png' %}" alt="Profile" />
                {% endif %}
            </label>
            <input type="file" name="profile_picture" id="profile_picture" style="display:none;" onchange="this.form.submit();">
        </form>
        <form action="{% url 'update_profile_picture' %}" method="post">
            {% csrf_token %}
            {% if teacher.profile_picture %}
                <button type="submit" name="delete_picture" value="1">Delete</button>
            {% endif %}
        </form>
    </div>

    <div>
        <h1>Welcome, {{ teacher.user.get_full_name }}</h1>
    </div>
</div>

<form method="get" class="filters">
    <label>Week:</label>
    <select name="week">
        <option value="">All</option>
        {% for week in weeks %}
            <option value="{{ week.id }}" {% if week.id|stringformat:"s" == selected_week %}selected{% endif %}>Week {{ week.number }}</option>
        {% endfor %}
    </select>

    <label>Class:</label>
    <select name="class_group">
        <option value="">All</option>
        {% for c in classes %}
            <option value="{{ c.id }}" {% if c.id|stringformat:"s" == selected_class %}selected{% endif %}>{{ c.name }}</option>
        {% endfor %}
    </select>

    <label>Subject:</label>
    <select name="subject">
        <option value="">All</option>
        {% for s in subjects %}
            <option value="{{ s.id }}" {% if s.id|stringformat:"s" == selected_subject %}selected{% endif %}>{{ s.name }}</option>
        {% endfor %}
    </select>

    <button type="submit">Filter</button>
</form>

<div class="cards-container">
    <div class="card"><h3>Total Lessons</h3><p>{{ total_lessons }}</p></div>
    <div class="card"><h3>Attended</h3><p>{{ attended }}</p></div>
    <div class="card"><h3>Not Attended</h3><p>{{ not_attended }}</p></div>
    <div class="card"><h3>Pending</h3><p>{{ pending }}</p></div>
    <div class="card"><h3>Paid</h3><p>{{ paid }}</p></div>
    <div class="card"><h3>Unpaid</h3><p>{{ unpaid }}</p></div>
</div>

<h2>Lessons Details</h2>
<table class="lessons-table">
    <thead>
        <tr>
            <th>Week</th>
            <th>Class</th>
            <th>Subject</th>
            <th>Status</th>
            <th>Payment Status</th>
            <th>Amount</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for lesson in lessons %}
        <tr>
            <td>{{ lesson.week.number }}</td>
            <td>
                {% for c in lesson.timetable.class_groups.all %}
                    {{ c.name }}{% if not forloop.last %}, {% endif %}
                {% endfor %}
            </td>
            <td>{{ lesson.timetable.subject }}</td>
            <td>{{ lesson.status }}</td>
            <td>{{ lesson.payment_status }}</td>
            <td>${{ lesson.amount|floatformat:2 }}</td>
            <td>
                {% if lesson.status == "Not Attended" or lesson.status == "Pending" %}
                    <form action="{% url 'mark_attended' lesson.id %}" method="post" style="display:inline;">
                        {% csrf_token %}
                        <button type="submit">Mark Attended</button>
                    </form>
                {% endif %}
            </td>
        </tr>
        {% empty %}
        <tr><td colspan="7">No lessons found.</td></tr>
        {% endfor %}
    </tbody>
</table>

<h2>Quick Add Lesson</h2>
<form method="post" action="{% url 'add_lesson' %}">
    {% csrf_token %}
    <label>Week:</label>
    <select name="week" required>
        {% for week in weeks %}
            <option value="{{ week.id }}">Week {{ week.number }}</option>
        {% endfor %}
    </select>

    <label>Timetable (slot):</label>
    <select name="timetable" required>
        {% for t in timetables %}
            <option value="{{ t.id }}">{{ t.subject }} - {{ t.start_time }} ({{ t.class_groups.all|join:", " }})</option>
        {% endfor %}
    </select>

    <button type="submit">Add Lesson</button>
</form>

{% endblock %}
